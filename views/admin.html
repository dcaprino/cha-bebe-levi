<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Administrativo - ChÃ¡ do BebÃª Levi</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-4">
  <h1 class="text-2xl font-bold mb-4">Painel Administrativo</h1>
  <p class="mb-4">Gerencie os nÃºmeros, visualize status e exporte dados.</p>
<div class="flex flex-wrap gap-2 mb-4">
  <input id="filterName" type="text" placeholder="Filtrar por nome"
    class="border rounded px-2 py-1 text-sm w-48" />
  <select id="filterStatus" class="border rounded px-2 py-1 text-sm">
    <option value="">Todos</option>
    <option value="free">Livres</option>
    <option value="occupied">Ocupados</option>
  </select>
  <button id="applyFilter" class="px-3 py-1 bg-gray-700 text-white rounded text-sm">Filtrar</button>
</div>
  
<button id="exportBtn" class="mb-4 px-3 py-2 bg-blue-600 text-white rounded">Exportar CSV</button>
<div id="stats" class="bg-white p-4 rounded shadow mb-4 text-sm">
  <p><strong>Total de nÃºmeros:</strong> <span id="stTotal"></span></p>
  <p><strong>Ocupados:</strong> <span id="stOccupied"></span></p>
  <p><strong>Convidados:</strong> <span id="stGuests"></span></p>
  <p><strong>Ãšltimo cadastro:</strong> <span id="stLast"></span></p>
  <button id="resetAllBtn" class="mt-3 px-3 py-2 bg-red-600 text-white rounded">ðŸ”„ Limpar Tudo</button>
</div>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border shadow">
      <thead class="bg-gray-200">
<tr>
  <th class="py-2 px-4 border">NÃºmero</th>
  <th class="py-2 px-4 border">Status</th>
  <th class="py-2 px-4 border">Convidado</th>
  <th class="py-2 px-4 border">WhatsApp</th>
  <th class="py-2 px-4 border">Itens</th>
  <th class="py-2 px-4 border">AÃ§Ãµes</th>
</tr>

      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
<script>
let fullList = [];

function render(list) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  list.forEach(n => {
    const tr = document.createElement('tr');
tr.innerHTML = `
  <td class="border px-4 py-2">${n.label}</td>
  <td class="border px-4 py-2">${n.status}</td>
  <td class="border px-4 py-2">${n.guestName || ''}</td>
  <td class="border px-4 py-2">${n.guestPhone || ''}</td>
  <td class="border px-4 py-2">${n.items.description}</td>
  <td class="border px-4 py-2">
    ${n.status !== 'free' ? '<button class="text-red-600 underline" data-id="'+n.id+'">Liberar</button>' : ''}
  </td>
`;

    const btn = tr.querySelector('button');
    if (btn) {
      btn.addEventListener('click', () => {
        fetch('/api/release', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id: n.id })
        }).then(() => load());
      });
    }
    tbody.appendChild(tr);
  });
}

function load() {
  fetch('/api/numbers')
    .then(res => res.json())
    .then(list => {
      fullList = list;
      render(list);
      loadStats();
    });
}

function loadStats() {
  fetch("/api/admin/stats")
    .then(r => r.json())
    .then(s => {
      document.getElementById("stTotal").textContent = s.totalNumbers;
      document.getElementById("stOccupied").textContent = s.occupied;
      document.getElementById("stGuests").textContent = s.totalGuests;
      document.getElementById("stLast").textContent = s.lastGuest || "-";
    });
}

document.getElementById("resetAllBtn").addEventListener("click", () => {
  if (confirm("Deseja realmente limpar todo o histÃ³rico?")) {
    fetch("/api/admin/reset", { method: "POST" })
      .then(() => load());
  }
});

document.getElementById('applyFilter').addEventListener('click', () => {
  const name = document.getElementById('filterName').value.toLowerCase();
  const status = document.getElementById('filterStatus').value;
  const filtered = fullList.filter(n =>
    (!name || (n.guestName || '').toLowerCase().includes(name)) &&
    (!status || n.status === status)
  );
  render(filtered);
});

document.getElementById('exportBtn').addEventListener('click', () => {
  window.location.href = '/api/export';
});

load();
</script>

</body>
</html>